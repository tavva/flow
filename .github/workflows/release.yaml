name: Release Flow

on:
    push:
        tags:
            - '*'

env:
    FLOW_RELEASE_REPO: tavva/flow-release

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Use Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: Build plugin
              run: |
                  bun install
                  bun run build

            - name: Create release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  tag="${GITHUB_REF#refs/tags/}"

                  gh release create "$tag" \
                    --title="$tag" \
                    --draft \
                    main.js manifest.json styles.css

            - name: Clone flow-release repository
              run: |
                  git clone https://github.com/${{ env.FLOW_RELEASE_REPO }} flow-release
                  cd flow-release
                  git config user.name "${{ github.actor }}"
                  git config user.email "${{ github.actor }}@users.noreply.github.com"

            - name: Copy README.md
              run: |
                  cp docs/README.md flow-release/README.md

            - name: Commit and push README.md to flow-release
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
              run: |
                  cd flow-release
                  git add README.md
                  if git diff --cached --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "Update README.md for ${{ env.TAG_NAME }}"
                    git push https://${{ env.FLOW_RELEASE_PAT }}@github.com/${{ env.FLOW_RELEASE_REPO }} HEAD:main
                  fi

            - name: Create release in flow-release
              id: create_release
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
                  TAG_NAME: ${{ github.ref_name }}
              run: |
                  response=$(curl -s -X POST \
                  -H "Authorization: token $FLOW_RELEASE_PAT" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "tag_name": "'"$TAG_NAME"'",
                    "name": "Release '"$TAG_NAME"'",
                    "body": "Automated release from flow repository.",
                    "draft": true,
                    "prerelease": false
                  }' \
                  https://api.github.com/repos/tavva/flow-release/releases)
                  echo "$response"
                  upload_url=$(echo "$response" | jq -r .upload_url | sed -e "s/{?name,label}//")
                  echo "upload_url=$upload_url" >> $GITHUB_OUTPUT

            - name: Upload assets
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
              run: |
                  for file in main.js styles.css manifest.json; do
                    curl -s -X POST \
                      -H "Authorization: token $FLOW_RELEASE_PAT" \
                      -H "Content-Type: $(file --mime-type -b $file)" \
                      --data-binary @$file \
                      "${{ steps.create_release.outputs.upload_url }}?name=$(basename $file)"
                  done
