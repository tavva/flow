name: Release Flow

on:
    push:
        tags:
            - '*'

jobs:
    preflight:
        runs-on: ubuntu-latest
        env:
            TAG_NAME: ${{ github.ref_name }}

        steps:
            - uses: actions/checkout@v3

            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'

            - name: Ensure versions match tag
              run: |
                  node - <<'NODE'
                  const fs = require('fs')
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'))
                  const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'))
                  const tag = process.env.TAG_NAME || ''
                  const normalizedTag = tag.startsWith('v') ? tag.slice(1) : tag
                  if (pkg.version !== manifest.version) {
                      console.error(`package.json version ${pkg.version} does not match manifest.json version ${manifest.version}`)
                      process.exit(1)
                  }
                  if (pkg.version !== normalizedTag) {
                      console.error(`Version ${pkg.version} does not match tag ${tag}`)
                      process.exit(1)
                  }
                  NODE

            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Verify build and tests
              run: npm run verify

            - name: Create plugin zip
              run: |
                  ZIP_NAME="flow.zip"
                  echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
                  rm -f "$ZIP_NAME"
                  zip -j "$ZIP_NAME" main.js styles.css manifest.json

            - name: Upload plugin bundle
              uses: actions/upload-artifact@v4
              with:
                  name: plugin-build
                  path: |
                      main.js
                      styles.css
                      manifest.json
                      ${{ env.ZIP_NAME }}

    release:
        needs: preflight
        runs-on: ubuntu-latest
        env:
            TAG_NAME: ${{ github.ref_name }}

        steps:
            - uses: actions/checkout@v3

            - name: Download plugin bundle
              uses: actions/download-artifact@v4
              with:
                  name: plugin-build
                  path: release-assets

            - name: Prepare assets
              run: cp release-assets/* .

            - name: Determine zip name
              run: echo "ZIP_NAME=flow.zip" >> $GITHUB_ENV

            - name: Create release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release create "${TAG_NAME}" \
                    --title="${TAG_NAME}" \
                    --draft \
                    main.js manifest.json styles.css "${ZIP_NAME}"
