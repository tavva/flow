name: Release Flow

on:
    push:
        tags:
            - '*'

env:
    FLOW_RELEASE_REPO: tavva/flow-release

jobs:
    preflight:
        runs-on: ubuntu-latest
        env:
            TAG_NAME: ${{ github.ref_name }}

        steps:
            - uses: actions/checkout@v3

            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'

            - name: Ensure versions match tag
              run: |
                  node - <<'NODE'
                  const fs = require('fs')
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'))
                  const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'))
                  const tag = process.env.TAG_NAME || ''
                  const normalizedTag = tag.startsWith('v') ? tag.slice(1) : tag
                  if (pkg.version !== manifest.version) {
                      console.error(`package.json version ${pkg.version} does not match manifest.json version ${manifest.version}`)
                      process.exit(1)
                  }
                  if (pkg.version !== normalizedTag) {
                      console.error(`Version ${pkg.version} does not match tag ${tag}`)
                      process.exit(1)
                  }
                  NODE

            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Verify build and tests
              run: npm run verify

            - name: Create plugin zip
              run: |
                  ZIP_NAME="flow.zip"
                  echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
                  rm -f "$ZIP_NAME"
                  zip -j "$ZIP_NAME" main.js styles.css manifest.json

            - name: Upload plugin bundle
              uses: actions/upload-artifact@v4
              with:
                  name: plugin-build
                  path: |
                      main.js
                      styles.css
                      manifest.json
                      ${{ env.ZIP_NAME }}

    release:
        needs: preflight
        runs-on: ubuntu-latest
        env:
            TAG_NAME: ${{ github.ref_name }}

        steps:
            - uses: actions/checkout@v3

            - name: Download plugin bundle
              uses: actions/download-artifact@v4
              with:
                  name: plugin-build
                  path: release-assets

            - name: Prepare assets
              run: cp release-assets/* .

            - name: Determine zip name
              run: echo "ZIP_NAME=flow.zip" >> $GITHUB_ENV

            - name: Create release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release create "${TAG_NAME}" \
                    --title="${TAG_NAME}" \
                    --draft \
                    main.js manifest.json styles.css "${ZIP_NAME}"

            - name: Clone flow-release repository
              run: |
                  git clone https://github.com/${{ env.FLOW_RELEASE_REPO }} flow-release
                  cd flow-release
                  git config user.name "${{ github.actor }}"
                  git config user.email "${{ github.actor }}@users.noreply.github.com"

            - name: Copy README.md
              run: |
                  cp docs/README.md flow-release/README.md

            - name: Commit and push README.md to flow-release
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
              run: |
                  cd flow-release
                  git add README.md
                  if git diff --cached --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "Update README.md for ${{ env.TAG_NAME }}"
                    git push https://${{ env.FLOW_RELEASE_PAT }}@github.com/${{ env.FLOW_RELEASE_REPO }} HEAD:main
                  fi

            - name: Create release in flow-release
              id: create_release
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
              run: |
                  response=$(curl -s -X POST \
                  -H "Authorization: token $FLOW_RELEASE_PAT" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "tag_name": "'"$TAG_NAME"'",
                    "name": "Release '"$TAG_NAME"'",
                    "body": "Automated release from flow repository.",
                    "draft": true,
                    "prerelease": false
                  }' \
                  https://api.github.com/repos/tavva/flow-release/releases)
                  echo "$response"
                  upload_url=$(echo "$response" | jq -r .upload_url | sed -e "s/{?name,label}//")
                  echo "upload_url=$upload_url" >> $GITHUB_OUTPUT

            - name: Upload assets
              env:
                  FLOW_RELEASE_PAT: ${{ secrets.FLOW_RELEASE_PAT }}
              run: |
                  for file in main.js styles.css manifest.json "${ZIP_NAME}"; do
                    curl -s -X POST \
                      -H "Authorization: token $FLOW_RELEASE_PAT" \
                      -H "Content-Type: $(file --mime-type -b $file)" \
                      --data-binary @$file \
                      "${{ steps.create_release.outputs.upload_url }}?name=$(basename $file)"
                  done
